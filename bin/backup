#!/bin/bash
set -e

ARCHIVE="/homefarm/homefarm.backup.tar.gz"
cd /homefarm

# no arguments: create tarball
if [[ "${1}" == "" ]]; then
    tar zcvf ${ARCHIVE} ./.ssh \
        ./.boincguikeys.json \
        ./.current_tag \
        ./.mirror_url \
        ./farm.cfg \
        ./nodes/ \
        ./srv/pacman.conf \
        ./srv/mirrorlist >> /dev/null
    echo "Farm configuration archived to ${ARCHIVE}"
    exit
fi

# any argument other than "restore": print out the help message
if [[ "${1}" != "restore" ]]; then
    cat <<EOF
usage is:

    ./bin/backup # create archive tarball

    ./bin/backup --restore # unpack archive and restore farm state

EOF
    exit 1
fi

# if we're down here, then we're restoring a tarball. unpack it, and
# move everything that belongs somewhere else to that location.
if [[ ! -e ${ARCHIVE} ]]; then
    echo "error: can't find archive file ${ARCHIVE}"
    exit 1
fi
echo "Unpacking tarball"
tar zxvf ${ARCHIVE} >> /dev/null
echo "Restoring local package mirror"
. ./bin/common.sh
mkdir -p /homefarm/srv/arch
MIRROR_URL=$(cat ./.mirror_url)
LOCALREPO="/homefarm/srv/arch"
update_localrepo "${LOCALREPO}" "${MIRROR_URL}"
echo "Farm backup and repo restored."
