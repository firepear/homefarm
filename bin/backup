#!/bin/bash
set -e

ARCHIVE="/homefarm/homefarm.backup.tar.gz"
cd /homefarm

# no arguments: create tarball
if [[ "${1}" == "" ]]; then
    tar zcvf ${ARCHIVE} ./.ssh \
        homefarm/.current_tag homefarm/farm.cfg homefarm/nodes/ \
        ./srv/pacman.conf \
        ./srv/mirrorlist >> /dev/null
    echo "Farm configuration archived to ${ARCHIVE}"
    exit
fi

# any argument other than "restore": print out the help message
if [[ "${1}" != "restore" ]]; then
    cat <<EOF
usage is:

    ./bin/backup # create archive tarball

    ./bin/backup --restore # unpack archive and restore farm state

EOF
    exit 1
fi

# if we're down here, then we're restoring a tarball. unpack it, and
# move everything that belongs somewhere else to that location.
if [[ ! -e ${ARCHIVE} ]]; then
    echo "error: can't find archive file ${ARCHIVE}"
    exit 1
fi
echo "Unpacking tarball"
tar zxvf ${ARCHIVE} >> /dev/null
cp ./.ssh/id_farmer.pub ./srv/homefarm
mv etc/hosts /etc/hosts
rmdir etc
echo "Farm configuration restored"
