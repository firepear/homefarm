#!/usr/bin/env bash

# Copyright (c) 2017-2020 Shawn Boyette <shawn@firepear.net>. All
# rights reserved.  Use of this source code is governed by a BSD-style
# license that can be found in the LICENSE file.

set -e

VERSION=$(git tag | tail -1)

# hf_init takes the place of the old control-install script. it
# handles the initial node setup, other than package install (which is
# done by the docker build)
function hf_init() {
    # generate ssh key
    shownotice "Generating SSH configuration for Ansible"
    if [[ -e /root/.ssh/id_farmer ]]; then
        echo "Skipping; already configured"
    else
        ssh-keygen -t ed25519 -N "" -f id_farmer
        mkdir -p /homefarm/.ssh
        mv id_farmer* /homefarm/.ssh
        chmod 700 /homefarm/.ssh
        /usr/bin/keychain -q --host control /homefarm/.ssh/id_farmer >> /dev/null 2>&1
        source /root/.keychain/control-sh >> /dev/null 2>&1
    fi

    # do local files and httpd setup
    shownotice "Configuring Homefarm installer webserver"
    if [[ -e /homefarm/srv/pacman.conf ]]; then
        echo "Skipping; already configured"
    else
        HOSTADDR=$(gutcheck "Docker host's address (e.g. 10.1.10.114)")
        sedexpr="s/CONTROL_NODE_IP/${HOSTADDR}/"
        sed -e "${sedexpr}" ./files/pacman.conf > ./srv/pacman.conf
        # copy the example farm inventory file to the real one
        cp ./files/farm.cfg ./farm.cfg
        # make the nodes directory for user convenience
        mkdir -p /homefarm/nodes
        # create local package cache dir
        mkdir -p /homefarm/srv/arch
    fi

    # copy ssh pubkey for distribution to nodes
    cp /homefarm/.ssh/id_farmer.pub /homefarm/srv
    # symlink install/setup scripts
    ln -fs /homefarm/bin/node-install /homefarm/srv
    ln -fs /homefarm/bin/node-setup /homefarm/srv
    ln -fs /homefarm/bin/common.sh /homefarm/srv
    ln -fs /homefarm/bin/util/fix-wlan0 /homefarm/srv

    shownotice "Initializing local package mirror"
    if [[ -e /homefarm/.mirror_url ]]; then
        echo "Skipping; already configured"
    else
        MIRROR_URL=$(gutcheck "URL of remote repo (e.g. http://mirrors.ocf.berkeley.edu/archlinux/)")
        echo "${MIRROR_URL}" > ./.mirror_url
        LOCALREPO="/homefarm/srv/arch"
        update_localrepo "${LOCALREPO}" "${MIRROR_URL}"
    fi

    shownotice "Setup complete"
}

# since /etc/hosts on a docker container is transient, but we need to
# have the compute nodes in it for a lot of things to work, we'll
# parse them out of farm.cfg and inject them into the hostsfile
function hf_buildhosts() {
    found_nodes="false"
    while read -r line; do
        if [[ "${found_nodes}" == "true" ]]; then
            nodename=$(echo "${line}" | cut -d' ' -f1)
            nodeip=$(echo "${line}" | awk '{print $2}' | cut -d'=' -f2)
            echo "${nodeip} ${nodename}" >> /etc/hosts
        fi
        if [[ "${line}" =~ compute_nodes ]]; then
            found_nodes="true"
        fi
    done < ./farm.cfg
}

# to support one-shot commands, we need to do environment
# initialization without starting bash. so it lives here.
function hf_envinit() {
    /bin/ln -s /homefarm/.ssh /root/.ssh
    /bin/ln -s /homefarm/bin/complete /root/.bashrc
    touch ./.bash_history
    /bin/ln -s /homefarm/.bash_history /root/.bash_history
    /usr/bin/keychain -q --host control /homefarm/.ssh/id_farmer >> /dev/null 2>&1
    source /root/.keychain/control-sh >> /dev/null 2>&1
}


################################################################################

# if we're not starting up the container, then put ourselves in a
# known location
if [[ "${1}" != "up" ]] && [[ "${1}" != "restore" ]] && [[ "${1}" != "status-only" ]] && [[ "${1}" != "help" ]] && [[ "${1}" != "" ]]; then
    cd /homefarm
    source ./bin/common.sh
fi


case "${1}" in
    init)
        hf_init
        ;;
    backup)
        exec ./bin/backup
        ;;
    cmd)
        exec ./bin/utils/farmcmd "${2}"
        ;;
    on-up)
        localip=$(awk 'END{print $1}' /etc/hosts)
        echo
        echo "Welcome to homefarm ${VERSION}"
        echo "    Local IP is ${localip}"
        echo "    Installer httpd is listening on DOCKERHOST:9099"
        echo "    Run 'farmctl' to see options, or refer to the docs"
        echo
        hf_envinit
        hf_buildhosts
        /usr/bin/darkhttpd /homefarm/srv --port 80 --daemon >> /dev/null
        exec env PATH="${PATH}:/homefarm/bin" /bin/bash
        ;;
    node-init)
        exec /bin/ansible-playbook nodes-boinc-setup.yml
        ;;
    project-sync)
        exec /bin/ansible-playbook nodes-sync-projects.yml
        ;;
    restore)
        if [[ "${2}" == "" ]]; then
            echo "restore: homefarm directory must be specified"
        fi
        cd ${2}
        source ./bin/common.sh
        exec docker run --rm -p 9099:80 -v "${2}:/homefarm" -it control ./bin/backup restore
        ;;
    status)
        tmpfile=$(mktemp)
        statsarg="${2}"
        wantnode=""
        if [[ "${statsarg}" != "nopage" ]]; then
            wantnode="${statsarg}"
        fi
        ./bin/stats "${tmpfile}" "${wantnode}"
        tmplines=$(wc -l ${tmpfile} | cut -d' ' -f1)
        if [[ "${statsarg}" == "nopage" ]]; then
            cat ${tmpfile}
        else
            if [[ ${tmplines} -gt ${LINES} ]]; then
                less ${tmpfile}
            else
                cat ${tmpfile}
            fi
        fi
        rm ${tmpfile}
        ;;
    status-only)
        if [[ -e /root/.bashrc ]]; then
            echo "This command cannot be run within an interactive environment."
            exit 0
        fi
        if [[ "${2}" == "" ]]; then
            HOMEFARM_DIR=~/homefarm
        else
            HOMEFARM_DIR="${2}"
        fi
        exec docker run --rm -p 9099:80 -v "${HOMEFARM_DIR}:/homefarm" -it control ./bin/farmctl status-only2
        ;;
    status-only2)
        hf_envinit
        hf_buildhosts
        ./bin/farmctl status nopage
        ;;
    up)
        if [[ "${2}" == "" ]]; then
            HOMEFARM_DIR=~/homefarm
        else
            HOMEFARM_DIR="${2}"
        fi
        exec docker run --rm -p 9099:80 -v "${HOMEFARM_DIR}:/homefarm" -it control ./bin/farmctl on-up
        ;;
    update)
        exec ./bin/update "${2}"
        ;;
    version)
        echo "Homefarm ${VERSION}"
        exit 0
        ;;
    *)
        if [[ "${1}" != "" && "${1}" != "help" ]]; then
            echo "error: unknown argument '${1}'"
        fi
        cat <<EOF
usage: ${0} SUBCOMMAND [ARGS]

  backup
      Create tarball with all farm-specific files

  cmd <COMMAND_LINE>
      Run a command on all nodes. COMMAND_LINE be a single argument, so use
      quotes as appropriate

  node-init
      Do initial BOINC configuration on compute nodes

  status [nopage]
      Display info on current tasks. Specifying 'nopage' inhibits autopaging

  project-sync
      Sync project statuses to compute nodes

  restore <HOMEFARM_DIR>
      Restore farm state from a tarball created by 'farmctl backup'. Tarball must
      be in HOMEFARM_DIR

  update
      Update Homefarm, the local repository, and OS packages on compute nodes

  version
      Display version information
EOF
esac

#    query <PROJECT_URL> [-t <WU_TYPE>] [-s <TIMESPAN>]
#      Generate counts and runtime data for WUs completed on a project in a given
#      time. Defaults: all WUs; 24h

