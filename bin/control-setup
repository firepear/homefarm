#!/bin/bash
set -e

# copy the example config to the real config
cp farm.cfg.example farm.cfg
chown pi:pi farm.cfg

# update the system
echo "Updating system software..."
sleep 1
apt-get update
apt-get --yes dist-upgrade

# install pip
echo
echo
echo "Installing pip (the Python package manager)..."
sleep 1
apt-get --yes install python3-pip

# install ansible
echo
echo
echo "Installing ansible..."
sleep 1
pip3 install ansible

# generate ssh key
echo
echo
echo "Generating SSH configuration for Ansible..."
sleep 1
apt-get --yes install keychain
ssh-keygen -t ecdsa -N "" -f id_ecdsa
mkdir -p /home/pi/.ssh
mv id_ecdsa* /home/pi/.ssh
chown -R pi:pi /home/pi/.ssh
chmod 700 /home/pi/.ssh
echo <<EOF >> /home/pi/.bashrc

# set up easy ssh-agent for homefarm
/usr/bin/keychain ~/.ssh/id_ecdsa
source ~/.keychain/${HOSTNAME}-sh > /dev/null
EOF

# setup dir for serving to compute nodes
echo
echo
echo "Finalizing controller setup..."
sleep 1
mkdir http
cp /home/pi/.ssh/id_ecdsa.pub ./http
ln -s /home/pi/homefarm/bin/compute-setup ./http
chown -R pi:pi http

echo "Setup complete. Rebooting in 5 seconds!"
sleep 5
reboot
