#!/bin/bash
set -e
. ./bin/util.sh

# copy the example farm inventory file to the real one
cp examples/farm.cfg farm.cfg
chown pi:pi farm.cfg

# update the system
shownotice "Updating system software..."
sleep 1
apt-get update
apt-get --yes dist-upgrade

# install pip
shownotice "Installing pip (the Python package manager)..."
sleep 1
apt-get --yes install python3-pip

# install ansible
shownotice "Installing ansible..."
sleep 1
pip3 install ansible

# generate ssh key
shownotice "Generating SSH configuration for Ansible..."
sleep 1
apt-get --yes install keychain
ssh-keygen -t ed25519 -N "" -f id_farmer
mkdir -p /home/pi/.ssh
mv id_farmer* /home/pi/.ssh
chown -R pi:pi /home/pi/.ssh
chmod 700 /home/pi/.ssh
cat <<EOF | tee -a /home/pi/.bashrc > /dev/null

# set up easy ssh-agent for homefarm
/usr/bin/keychain ~/.ssh/id_farmer
source ~/.keychain/${HOSTNAME}-sh > /dev/null
EOF

# setup dir for serving to compute nodes and do a tiny bit of
# housekeeping
shownotice "Finalizing controller setup..."
sleep 1
mkdir http
cp /home/pi/.ssh/id_farmer.pub ./http
ln -s /home/pi/homefarm/bin/compute-setup ./http
chown -R pi:pi http
apt-get --yes install boinctui
apt-get clean

shownotice "Setup complete. Rebooting in 5 seconds!"
sleep 5
reboot
