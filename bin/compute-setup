#!/bin/bash
set -e
cd /root

# source util funcs
. ./util.sh

# install preqs
shownotice "Homefarm setup beginning"
shownotice "Installing Ansible prerequisites"
yes | pacman -S --needed python python-pip linux-headers gcc make autoconf libffi openssl sudo tar
# upgrade pip to avoid dep problems in ansible install
pip3 install --upgrade pip
# we need a just plain "python" executable for ansible
ln -f -s /usr/bin/python3 /usr/bin/python

# install ansible
shownotice "Installing Ansible"
pip3 install ansible

# create user, set passwd, config sudo access, and setup ssh keys
shownotice "Creating user for Ansible"
useradd -d /home/farmer -m -s /bin/bash farmer
passwd=$( openssl passwd -1 -salt BOINC "$(openssl rand -base64 32)" )
usermod -p "${passwd}" farmer
echo "farmer ALL=(ALL) NOPASSWD:ALL" | tee -a /etc/sudoers > /dev/null
mkdir -p /home/farmer/.ssh
chmod 700 /home/farmer/.ssh
mv id_farmer.pub /home/farmer/.ssh/authorized_keys
chown -R farmer:farmer /home/farmer/.ssh
sed -i -E 's/^\#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

shownotice "Configuring sensors"
/usr/bin/sensors-detect --auto

shownotice "Setting boot parameters"
# add vsyscall to kernel boot parameters
vsyscall_enable=$(grep -c vsyscall /boot/loader/entries/arch.conf) || true
if [[ "${vsyscall_enable}" == "0" ]]; then
    sed -i -E 's/^(options\s+.*)$/\1 vsyscall=emulate/' /boot/loader/entries/arch.conf
fi

shownotice "Setup complete"
echo "Rebooting in 5 seconds."
sleep 5
reboot
